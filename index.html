<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Visualizador de Ventas (Mes vs Año)</title>

  <!-- Librerías (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.20.2/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>

  <style>
    :root { --bg:#0b0f1a; --card:#121a2a; --text:#e8eefc; --muted:#98a6c6; --border:#24314d; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; background:var(--bg); color:var(--text); }
    .wrap { max-width: 1100px; margin: 24px auto; padding: 0 14px; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .row > * { flex: 0 0 auto; }
    .spacer { flex: 1 1 auto; }
    label { color:var(--muted); font-size:14px; }
    input[type="file"] { color:var(--muted); }
    .chk { display:flex; gap:8px; align-items:center; }
    .btn {
      background:#1c2a47; color:var(--text); border:1px solid var(--border);
      padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:600;
    }
    .btn:disabled { opacity:.5; cursor:not-allowed; }
    .status { color:var(--muted); font-size:14px; }
    #chart { height: 430px; }
    table { width:100%; border-collapse:collapse; overflow:hidden; border-radius:12px; }
    th, td { border-bottom:1px solid var(--border); padding:10px; text-align:right; font-variant-numeric: tabular-nums; }
    th:first-child, td:first-child { text-align:left; }
    thead th { position:sticky; top:0; background:#0f172a; z-index:1; }
    .small { font-size:12px; color:var(--muted); margin-top:6px; }
    .hint { color:var(--muted); font-size:13px; line-height:1.35; }
    .pill { padding:6px 10px; border:1px solid var(--border); border-radius:999px; color:var(--muted); }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="row">
        <div>
          <label for="file">Cargar Excel (.xls/.xlsx)</label><br/>
          <input id="file" type="file" accept=".xls,.xlsx" />
        </div>

        <div class="chk">
          <input id="includeMemb" type="checkbox" checked />
          <label for="includeMemb">Incluir membresías</label>
        </div>

        <div class="chk">
          <input id="dedup" type="checkbox" />
          <label for="dedup">Eliminar filas duplicadas</label>
        </div>

        <div class="spacer"></div>

        <button id="exportCsv" class="btn" disabled>Exportar CSV</button>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="status" id="status">Sin archivo cargado.</div>
        <div class="spacer"></div>
        <div class="pill" id="totalPill">Total (filtrado): $0</div>
      </div>

      <div class="small">
        Membresías = Grupo para excel ∈ { MEMBRESIAS, MEMB HP, MEMB HB, MEMB HA, MEMB } (todas juntas).
      </div>
    </div>

    <div class="card" style="margin-top:14px;">
      <div id="chart"></div>
      <div class="hint" style="margin-top:8px;">
        Si un mes no tiene ventas, se grafica como 0 (línea continua). Si prefieres “cortes” en la línea, te lo cambio a null.
      </div>
    </div>

    <div class="card" style="margin-top:14px;">
      <div class="row" style="margin-bottom:10px;">
        <div style="font-weight:700;">Resumen (Mes x Año)</div>
        <div class="spacer"></div>
        <div class="hint" id="colsInfo"></div>
      </div>
      <div style="overflow:auto; max-height: 320px;">
        <table id="table"></table>
      </div>
    </div>
  </div>

<script>
  // ===== Config membresías =====
  const MEMB_GROUPS = new Set(["MEMBRESIAS","MEMB HP","MEMB HB","MEMB HA","MEMB"]);

  // Estado
  let RAW_ROWS = [];
  let LAST_PIVOT = null; // { years:[], matrix: [12][n], totalsByYear:[] }

  const elFile = document.getElementById('file');
  const elIncludeMemb = document.getElementById('includeMemb');
  const elDedup = document.getElementById('dedup');
  const elStatus = document.getElementById('status');
  const elTotalPill = document.getElementById('totalPill');
  const elExport = document.getElementById('exportCsv');
  const elTable = document.getElementById('table');
  const elColsInfo = document.getElementById('colsInfo');

  elFile.addEventListener('change', onLoadFile);
  elIncludeMemb.addEventListener('change', () => RAW_ROWS.length && recomputeAndRender());
  elDedup.addEventListener('change', () => RAW_ROWS.length && recomputeAndRender());
  elExport.addEventListener('click', exportPivotCsv);

  function normalizeName(s) {
    return (s ?? "")
      .toString()
      .trim()
      .toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g,'')     // quita tildes
      .replace(/[^a-z0-9]/g,'');                          // deja alfanumérico
  }

  function findColumn(headers, mustContainParts) {
    // mustContainParts: array de strings ya "normalizados"
    const normHeaders = headers.map(h => normalizeName(h));
    for (let i=0; i<normHeaders.length; i++) {
      const ok = mustContainParts.every(p => normHeaders[i].includes(p));
      if (ok) return headers[i];
    }
    return null;
  }

  function toMoneyNumber(v) {
    if (v == null) return NaN;
    if (typeof v === 'number' && Number.isFinite(v)) return v;
    const s = String(v).trim();
    const digits = s.replace(/[^\d]/g,''); // "$ 7,500" -> "7500"
    if (!digits) return NaN;
    return Number(digits);
  }

  // Convierte fechas:
  // - Date -> ok
  // - number -> Excel serial -> Date
  // - string -> intenta yyyy-mm-dd o dd/mm/yyyy
  function toDate(v) {
    if (v instanceof Date && !isNaN(v)) return v;

    if (typeof v === 'number' && Number.isFinite(v)) {
      // Excel serial date (aprox). Excel epoch 1899-12-30 (con bug 1900)
      const excelEpoch = new Date(Date.UTC(1899, 11, 30));
      const d = new Date(excelEpoch.getTime() + v * 86400000);
      if (!isNaN(d)) return d;
    }

    const s = String(v ?? '').trim();
    if (!s) return null;

    // yyyy-mm-dd
    let m = s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})/);
    if (m) {
      const [_, Y, Mo, D] = m;
      const d = new Date(Number(Y), Number(Mo)-1, Number(D));
      return isNaN(d) ? null : d;
    }

    // dd/mm/yyyy
    m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
    if (m) {
      const [_, D, Mo, Y] = m;
      const d = new Date(Number(Y), Number(Mo)-1, Number(D));
      return isNaN(d) ? null : d;
    }

    // fallback
    const d = new Date(s);
    return isNaN(d) ? null : d;
  }

  function monthLabel(i) {
    return ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"][i-1];
  }

  async function onLoadFile() {
    const file = elFile.files?.[0];
    if (!file) return;

    elStatus.textContent = `Leyendo: ${file.name} ...`;
    elExport.disabled = true;
    RAW_ROWS = [];
    LAST_PIVOT = null;

    try {
      const data = await file.arrayBuffer();
      const wb = XLSX.read(data, { type: 'array', cellDates: true });
      const sheetName = wb.SheetNames[0];
      const ws = wb.Sheets[sheetName];

      // defval: '' para no perder columnas en filas vacías
      const rows = XLSX.utils.sheet_to_json(ws, { defval: '' });

      if (!rows.length) {
        elStatus.textContent = `Archivo cargado, pero no hay filas.`;
        return;
      }

      // Detectar columnas desde headers reales del JSON
      const headers = Object.keys(rows[0]);

      const dateCol  = findColumn(headers, ["fecha","crea"]);     // "Fecha de creación"
      const priceCol = findColumn(headers, ["precio"]);           // "Precio"
      const groupCol = findColumn(headers, ["grupo","excel"]);    // "Grupo para excel"

      if (!dateCol || !priceCol || !groupCol) {
        elStatus.textContent = `No encontré columnas necesarias.`;
        elColsInfo.textContent =
          `Detectado: fecha=${dateCol ?? "NO"}, precio=${priceCol ?? "NO"}, grupo=${groupCol ?? "NO"}`;
        return;
      }

      elColsInfo.textContent = `Columnas: Fecha="${dateCol}", Precio="${priceCol}", Grupo="${groupCol}"`;

      RAW_ROWS = rows.map(r => ({
        date: toDate(r[dateCol]),
        sale: toMoneyNumber(r[priceCol]),
        group: String(r[groupCol] ?? '').trim()
      })).filter(x => x.date && Number.isFinite(x.sale));

      elStatus.textContent = `Cargado ${file.name} | Filas válidas: ${RAW_ROWS.length}`;
      recomputeAndRender();

    } catch (err) {
      console.error(err);
      elStatus.textContent = `Error leyendo archivo: ${err?.message ?? err}`;
    }
  }

  function recomputeAndRender() {
    const includeMemb = elIncludeMemb.checked;
    const dedup = elDedup.checked;

    let rows = RAW_ROWS;

    // Filtro membresías
    if (!includeMemb) {
      rows = rows.filter(r => !MEMB_GROUPS.has(r.group.trim().toUpperCase()));
    }

    // Opcional: eliminar duplicadas (simple hash)
    if (dedup) {
      const seen = new Set();
      const out = [];
      for (const r of rows) {
        const key = `${r.date.getFullYear()}-${r.date.getMonth()+1}-${r.date.getDate()}|${r.sale}|${r.group}`;
        if (!seen.has(key)) { seen.add(key); out.push(r); }
      }
      rows = out;
    }

    if (!rows.length) {
      Plotly.purge('chart');
      elTable.innerHTML = '';
      elTotalPill.textContent = `Total (filtrado): $0`;
      elStatus.textContent = `Sin datos con el filtro actual.`;
      elExport.disabled = true;
      return;
    }

    // Pivot Mes(1..12) x Año
    const yearSet = new Set(rows.map(r => r.date.getFullYear()));
    const years = Array.from(yearSet).sort((a,b)=>a-b);
    const idx = new Map(years.map((y,i)=>[y,i]));
    const M = Array.from({length:12}, () => Array(years.length).fill(0));

    let total = 0;
    for (const r of rows) {
      const y = r.date.getFullYear();
      const m = r.date.getMonth(); // 0..11
      const j = idx.get(y);
      M[m][j] += r.sale;
      total += r.sale;
    }

    LAST_PIVOT = { years, matrix: M, total };
    elTotalPill.textContent = `Total (filtrado): $${formatCLP(total)}`;
    elStatus.textContent = `Filas (filtradas): ${rows.length} | Membresías: ${includeMemb ? "Sí" : "No"} | Duplicadas: ${dedup ? "Sí" : "No"}`;

    renderChart(years, M);
    renderTable(years, M);
    elExport.disabled = false;
  }

  function renderChart(years, M) {
    const x = Array.from({length:12}, (_,i)=>i+1);
    const traces = years.map((y, j) => ({
      x,
      y: M.map(row => row[j]),
      mode: 'lines+markers',
      name: String(y),
      line: { width: 2 }
    }));

    const layout = {
      title: 'Ventas mensuales por año',
      paper_bgcolor: 'rgba(0,0,0,0)',
      plot_bgcolor: 'rgba(0,0,0,0)',
      font: { color: '#e8eefc' },
      xaxis: {
        title: 'Mes',
        tickmode: 'array',
        tickvals: x,
        ticktext: x.map(monthLabel),
        gridcolor: '#24314d'
      },
      yaxis: {
        title: 'Venta ($)',
        gridcolor: '#24314d',
        separatethousands: true
      },
      legend: { x: 0, y: 1, bgcolor: 'rgba(0,0,0,0)' },
      margin: { l: 70, r: 20, t: 55, b: 55 }
    };

    const config = { responsive: true, displaylogo: false };
    Plotly.newPlot('chart', traces, layout, config);
  }

  function renderTable(years, M) {
    let html = '';
    html += '<thead><tr><th>Mes</th>';
    for (const y of years) html += `<th>${y}</th>`;
    html += '</tr></thead><tbody>';

    for (let i=0; i<12; i++) {
      html += `<tr><td>${monthLabel(i+1)}</td>`;
      for (let j=0; j<years.length; j++) {
        html += `<td>${formatCLP(M[i][j])}</td>`;
      }
      html += '</tr>';
    }
    html += '</tbody>';
    elTable.innerHTML = html;
  }

  function exportPivotCsv() {
    if (!LAST_PIVOT) return;
    const { years, matrix: M } = LAST_PIVOT;

    const lines = [];
    lines.push(["Month", ...years.map(y => `y${y}`)].join(','));

    for (let i=0; i<12; i++) {
      const row = [i+1, ...years.map((_,j)=> Math.round(M[i][j]))];
      lines.push(row.join(','));
    }

    const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = 'ventas_mensuales.csv';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function formatCLP(n) {
    const x = Math.round(Number(n) || 0);
    return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
  }
</script>
</body>
</html>
